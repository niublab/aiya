# Matrix ESS Community å†…ç½‘éƒ¨ç½²è‡ªåŠ¨åŒ–è„šæœ¬

[![License: AGPL v3](https://img.shields.io/badge/License-AGPL%20v3-blue.svg)](https://www.gnu.org/licenses/agpl-3.0)
[![Version](https://img.shields.io/badge/Version-1.1.0-green.svg)](https://github.com/niublab/aiya)

## ğŸ“‹ é¡¹ç›®ç®€ä»‹

Matrix ESS Community å†…ç½‘éƒ¨ç½²è‡ªåŠ¨åŒ–è„šæœ¬æ˜¯ä¸€ä¸ªå®Œå…¨è‡ªåŠ¨åŒ–çš„Matrixè§†é¢‘ä¼šè®®æœåŠ¡éƒ¨ç½²è§£å†³æ–¹æ¡ˆï¼ŒåŸºäºElement Server Suite Community Edition (ESS Community)ï¼Œæ”¯æŒ50äººä»¥ä¸‹çš„è§†é¢‘ä¼šè®®éœ€æ±‚ï¼Œå…·å¤‡èœå•å¼äº¤äº’ç•Œé¢ï¼Œæ”¯æŒå†…ç½‘éƒ¨ç½²å’Œå¤–ç½‘è®¿é—®ã€‚

### âœ¨ ä¸»è¦ç‰¹æ€§

- ğŸš€ **ä¸€é”®éƒ¨ç½²** - é€šè¿‡å•ä¸€å‘½ä»¤å®Œæˆå®Œæ•´éƒ¨ç½²
- ğŸ¯ **å°ç™½å‹å¥½** - èœå•å¼äº¤äº’ç•Œé¢ï¼Œå±‚çº§æœ€å°‘ï¼Œ0ä¸ºè¿”å›/é€€å‡º
- ğŸ”’ **å®‰å…¨å¯é ** - è‡ªåŠ¨ç”Ÿæˆ32ä½å¯†ç ï¼ŒDNSéªŒè¯è¯ä¹¦ï¼Œæƒé™æ§åˆ¶
- ğŸŒ **ç½‘ç»œé€‚é…** - æ”¯æŒåŠ¨æ€å…¬ç½‘IP + DDNSï¼Œè‡ªå®šä¹‰ç«¯å£é…ç½®
- ğŸ› ï¸ **ç»´æŠ¤ä¾¿æ·** - æ”¯æŒé‡å¯ã€æ¸…ç†ã€å¤‡ä»½ç­‰ç»´æŠ¤åŠŸèƒ½
- ğŸ“Š **å®æ—¶ç›‘æ§** - æœåŠ¡çŠ¶æ€æ£€æŸ¥ï¼Œæ—¥å¿—æŸ¥çœ‹ï¼Œç½‘ç»œè¯Šæ–­

### ğŸ—ï¸ æŠ€æœ¯æ¶æ„

åŸºäºå®˜æ–¹ESS Communityæœ€æ–°ç‰ˆæœ¬ï¼ŒåŒ…å«ä»¥ä¸‹æ ¸å¿ƒç»„ä»¶ï¼š

- **Synapse** - MatrixæœåŠ¡å™¨æ ¸å¿ƒ
- **Matrix Authentication Service (MAS)** - åŸºäºOIDCçš„ä¸‹ä¸€ä»£è®¤è¯ç³»ç»Ÿ
- **Element Call's Matrix RTC Backend** - è§†é¢‘ä¼šè®®åç«¯æœåŠ¡
- **Element Web** - Webå®¢æˆ·ç«¯ç•Œé¢
- **PostgreSQL** - æ•°æ®åº“æœåŠ¡
- **HAProxy** - è´Ÿè½½å‡è¡¡å’Œè·¯ç”±
- **cert-manager** - è‡ªåŠ¨è¯ä¹¦ç®¡ç†
- **K3s** - è½»é‡çº§Kubernetesé›†ç¾¤

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç³»ç»Ÿè¦æ±‚

- **æ“ä½œç³»ç»Ÿ**: Debian/Ubuntuç³»åˆ—
- **ç¡¬ä»¶è¦æ±‚**: æœ€å°‘2 CPUæ ¸å¿ƒï¼Œ2GBå†…å­˜
- **ç½‘ç»œè¦æ±‚**: å…¬ç½‘IPï¼ˆåŠ¨æ€IP + DDNSæ”¯æŒï¼‰
- **æƒé™è¦æ±‚**: sudo/rootæƒé™

### ç«¯å£è¦æ±‚

- **HTTPç«¯å£**: 8080 (å¯è‡ªå®šä¹‰ï¼Œæ›¿ä»£80)
- **HTTPSç«¯å£**: 8443 (å¯è‡ªå®šä¹‰ï¼Œæ›¿ä»£443)
- **è”é‚¦ç«¯å£**: 8448 (Matrixè”é‚¦é€šä¿¡)
- **UDPç«¯å£æ®µ**: 30152-30352 (WebRTCé€šä¿¡)

### åŸŸåè¦æ±‚

éœ€è¦å‡†å¤‡ä»¥ä¸‹åŸŸåï¼ˆå‡éœ€è¦Aè®°å½•æŒ‡å‘æœåŠ¡å™¨IPï¼‰ï¼š

- ä¸»åŸŸå: `example.com` (MatrixæœåŠ¡å™¨å)
- Synapse: `matrix.example.com`
- MASè®¤è¯: `account.example.com`
- RTCåç«¯: `mrtc.example.com`
- Webå®¢æˆ·ç«¯: `chat.example.com`

### è¯ä¹¦è¦æ±‚

- **Cloudflare API Token** (ç”¨äºDNSéªŒè¯)
- **é‚®ç®±åœ°å€** (ç”¨äºLet's Encryptè¯ä¹¦ç”³è¯·)

## ğŸ“¦ ä¸€é”®å®‰è£…

```bash
bash <(curl -fsSL https://raw.githubusercontent.com/niublab/aiya/main/setup.sh)
```

## ğŸ“– ä½¿ç”¨æŒ‡å—

### 1. éƒ¨ç½²æµç¨‹

è„šæœ¬ä¼šå¼•å¯¼æ‚¨å®Œæˆä»¥ä¸‹æ­¥éª¤ï¼š

1. **ç¯å¢ƒæ£€æŸ¥** - ç³»ç»Ÿå…¼å®¹æ€§ã€ç½‘ç»œè¿é€šæ€§
2. **åŸºç¡€é…ç½®** - åŸŸåã€é‚®ç®±ã€ç›®å½•è®¾ç½®
3. **ç½‘ç»œé…ç½®** - ç«¯å£è®¾ç½®ã€å…¬ç½‘IPè·å–
4. **è¯ä¹¦é…ç½®** - è¯ä¹¦ç±»å‹ã€Cloudflare API Token
5. **æœåŠ¡é…ç½®** - æ•°æ®åº“ã€å­˜å‚¨è·¯å¾„
6. **éƒ¨ç½²ç¡®è®¤** - é…ç½®é¢„è§ˆã€ç¡®è®¤éƒ¨ç½²
7. **è‡ªåŠ¨éƒ¨ç½²** - K3sã€cert-managerã€ESSå®‰è£…
8. **ç”¨æˆ·åˆ›å»º** - åˆ›å»ºåˆå§‹ç®¡ç†å‘˜ç”¨æˆ·
9. **æœåŠ¡éªŒè¯** - éªŒè¯æ‰€æœ‰æœåŠ¡æ­£å¸¸è¿è¡Œ
10. **å®Œæˆæ€»ç»“** - æä¾›è®¿é—®ä¿¡æ¯å’Œåç»­æŒ‡å¯¼

### 2. ä¸»è¦åŠŸèƒ½

#### ğŸ”§ é…ç½®ç®¡ç†
- æ–°å»ºé…ç½®
- åŠ è½½é…ç½®
- æŸ¥çœ‹å½“å‰é…ç½®
- ä¿å­˜é…ç½®

#### ğŸ› ï¸ æœåŠ¡ç®¡ç†
- æŸ¥çœ‹æœåŠ¡çŠ¶æ€
- é‡å¯æœåŠ¡
- æŸ¥çœ‹æ—¥å¿—
- éªŒè¯éƒ¨ç½²

#### ğŸ§¹ æ¸…ç†ç¯å¢ƒ
- æ¸…ç†ESSæœåŠ¡ (ä¿ç•™K3så’Œcert-manager)
- æ¸…ç†åº”ç”¨ (ä¿ç•™K3sé›†ç¾¤)
- å®Œå…¨æ¸…ç† (åˆ é™¤æ‰€æœ‰ç»„ä»¶)

#### ğŸ” ç³»ç»Ÿå·¥å…·
- ç³»ç»Ÿä¿¡æ¯æŸ¥çœ‹
- ç½‘ç»œè¯Šæ–­
- å¤‡ä»½é…ç½®
- æ£€æŸ¥æ›´æ–°

### 3. é…ç½®ç¤ºä¾‹

```yaml
# ç«¯å£é…ç½®
ports:
  http: 8080
  https: 8443
  federation: 8448
  udp_range: "30152-30250"

# åŸŸåé…ç½®
domains:
  server_name: "example.com"
  synapse: "matrix.example.com"
  auth: "account.example.com"
  rtc: "mrtc.example.com"
  web: "chat.example.com"

# ç®¡ç†å‘˜é…ç½®
admin:
  username: "admin"
  password: "auto-generated-32-chars"
  email: "admin@example.com"  # å¯é€‰

# è¯ä¹¦é…ç½®
certificates:
  email: "certs@example.com"  # å¿…éœ€
  environment: "production"   # æˆ– "staging"
```

## ğŸ”’ å®‰å…¨è¯´æ˜

### è®¸å¯è¯é™åˆ¶

âš ï¸ **é‡è¦æé†’**: æœ¬è„šæœ¬åŸºäºAGPL-3.0è®¸å¯è¯ï¼Œ**ä»…é™ä¸ªäººã€å­¦ä¹ ã€ç ”ç©¶ç­‰éå•†ä¸šç”¨é€”**ï¼Œç¦æ­¢ç”¨äºä»»ä½•å•†ä¸šç›®çš„ã€‚

### å®‰å…¨ç‰¹æ€§

- **å¯†ç å®‰å…¨**: è‡ªåŠ¨ç”Ÿæˆ32ä½å¼ºå¯†ç 
- **è¯ä¹¦å®‰å…¨**: Let's Encryptæ­£å¼è¯ä¹¦ï¼ŒDNSéªŒè¯
- **ç½‘ç»œå®‰å…¨**: ä»…å¼€æ”¾å¿…è¦ç«¯å£ï¼Œå†…ç½‘éƒ¨ç½²
- **æƒé™æ§åˆ¶**: ä¸¥æ ¼æ§åˆ¶æ–‡ä»¶è®¿é—®æƒé™

## ğŸ› ï¸ ç»´æŠ¤æŒ‡å—

### æœåŠ¡é‡å¯

```bash
# é€šè¿‡è„šæœ¬èœå•
./setup.sh -> 3) æœåŠ¡ç®¡ç† -> 2) é‡å¯æœåŠ¡

# æ‰‹åŠ¨é‡å¯
kubectl rollout restart deployment -n ess
```

### æŸ¥çœ‹æ—¥å¿—

```bash
# é€šè¿‡è„šæœ¬èœå•
./setup.sh -> 3) æœåŠ¡ç®¡ç† -> 3) æŸ¥çœ‹æ—¥å¿—

# æ‰‹åŠ¨æŸ¥çœ‹
kubectl logs -n ess -l app.kubernetes.io/name=synapse -f
```

### å¤‡ä»½é…ç½®

```bash
# é€šè¿‡è„šæœ¬èœå•
./setup.sh -> 7) å¤‡ä»½é…ç½®

# æ‰‹åŠ¨å¤‡ä»½
cp -r /opt/matrix /backup/matrix-$(date +%Y%m%d)
```

### å®Œå…¨å¸è½½

```bash
# é€šè¿‡è„šæœ¬èœå•
./setup.sh -> 4) æ¸…ç†ç¯å¢ƒ -> 3) å®Œå…¨æ¸…ç†

# æ‰‹åŠ¨å¸è½½
helm uninstall ess -n ess
kubectl delete namespace ess
/usr/local/bin/k3s-uninstall.sh
```

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **ç«¯å£è¢«å ç”¨**
   - æ£€æŸ¥ç«¯å£å ç”¨: `netstat -tuln | grep :8080`
   - ä¿®æ”¹ç«¯å£é…ç½®æˆ–åœæ­¢å ç”¨è¿›ç¨‹

2. **åŸŸåè§£æå¤±è´¥**
   - æ£€æŸ¥DNSè®°å½•: `nslookup matrix.example.com`
   - ç¡®è®¤Aè®°å½•æŒ‡å‘æ­£ç¡®IP

3. **è¯ä¹¦ç”³è¯·å¤±è´¥**
   - æ£€æŸ¥Cloudflare API Tokenæƒé™
   - ç¡®è®¤åŸŸååœ¨Cloudflareæ‰˜ç®¡

4. **æœåŠ¡å¯åŠ¨å¤±è´¥**
   - æŸ¥çœ‹PodçŠ¶æ€: `kubectl get pods -n ess`
   - æŸ¥çœ‹äº‹ä»¶: `kubectl get events -n ess`

### è·å–å¸®åŠ©

- æŸ¥çœ‹è¯¦ç»†æ—¥å¿—: `kubectl logs -n ess <pod-name>`
- æ£€æŸ¥æœåŠ¡çŠ¶æ€: `kubectl describe pod -n ess <pod-name>`
- ç½‘ç»œè¯Šæ–­: ä½¿ç”¨è„šæœ¬å†…ç½®ç½‘ç»œè¯Šæ–­åŠŸèƒ½

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Element Server Suiteå®˜æ–¹æ–‡æ¡£](https://github.com/element-hq/ess-helm)
- [Matrixåè®®æ–‡æ¡£](https://matrix.org/docs/)
- [K3så®˜æ–¹æ–‡æ¡£](https://docs.k3s.io/)
- [cert-manageræ–‡æ¡£](https://cert-manager.io/docs/)

## ğŸ¤ è´¡çŒ®æŒ‡å—

æ¬¢è¿æäº¤Issueå’ŒPull Requestæ¥æ”¹è¿›è¿™ä¸ªé¡¹ç›®ã€‚

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®åŸºäº [AGPL-3.0](LICENSE-AGPL-3.0-only) è®¸å¯è¯ï¼Œä»…é™éå•†ä¸šç”¨é€”ã€‚

---

**âš ï¸ å…è´£å£°æ˜**: æœ¬è„šæœ¬ä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ä½¿ç”¨ï¼Œä½¿ç”¨è€…éœ€è‡ªè¡Œæ‰¿æ‹…ä½¿ç”¨é£é™©ã€‚
