# Matrix ESS Community 网络配置说明

## 🌐 网络环境要求

### 网络拓扑
```
用户网络拓扑: 路由器 -> 防火墙 -> 服务器(部署ESS)
ISP限制: 封锁80/443端口
网络特点: 动态公网IP + DDNS解析
```

## 📡 公网IP获取方式

脚本严格遵循需求文档要求，仅使用指定的IP获取方法：

### DDNS解析 (需求文档标准方法)
```bash
# 遵循需求文档的唯一标准方法
dig +short ip.your-domain.com @8.8.8.8
# 备用DNS服务器
dig +short ip.your-domain.com @1.1.1.1
```

**特点:**
- ✅ 严格遵循需求文档规范
- ✅ 使用自有域名解析
- ✅ 支持DDNS自动更新
- ✅ 可靠和稳定
- ✅ 无第三方服务依赖

**要求:**
- 必须配置 `ip.your-domain.com` 的A记录
- DDNS服务必须正常运行
- 域名DNS解析必须正常

## 🔧 网络检测功能

脚本包含完整的网络检测功能：

### 1. DNS解析检测
```bash
# 检测DNS服务器连通性
dig +short @8.8.8.8 google.com
dig +short @1.1.1.1 google.com
```

### 2. 公网IP获取检测
使用需求文档标准方法进行检测：
- **DDNS解析**: 检测 `ip.your-domain.com` 解析
- **IP格式验证**: 确保返回有效的IP地址格式

### 3. 域名解析检测
检测所有配置的域名：
- Element Web域名
- 认证服务域名  
- RTC服务域名
- Synapse域名

## 🚪 端口配置

### 默认端口配置 (可自定义)
- **HTTP端口**: 8080 (替代80)
- **HTTPS端口**: 8443 (替代443)
- **联邦端口**: 8448 (Matrix联邦通信)

### Kubernetes内部端口
- **NodePort HTTP**: 30080
- **NodePort HTTPS**: 30443
- **NodePort 联邦**: 30448

### WebRTC端口
- **TCP端口**: 30881
- **UDP端口**: 30882
- **UDP端口段**: 30152-30352

## 🔍 网络诊断

### 常见问题排查

#### 1. DDNS解析失败
```bash
# 手动测试DDNS解析
dig +short ip.your-domain.com @8.8.8.8
dig +short ip.your-domain.com @1.1.1.1

# 检查A记录配置
dig your-domain.com @8.8.8.8
```

**解决方案:**
- 确认 `ip.your-domain.com` A记录已创建
- 检查DDNS服务是否正常运行
- 验证域名DNS配置

#### 2. 域名解析失败
```bash
# 测试域名解析
dig app.your-domain.com @8.8.8.8     # Element Web
dig mas.your-domain.com @8.8.8.8     # 认证服务
dig rtc.your-domain.com @8.8.8.8     # RTC服务
dig matrix.your-domain.com @8.8.8.8  # Matrix服务器
```

**解决方案:**
- 确认所有子域名A记录已创建
- 检查DNS传播是否完成
- 验证域名服务商配置

#### 3. 网络连通性问题
```bash
# 测试基础网络
ping 8.8.8.8
ping 1.1.1.1

# 测试DNS服务
nslookup google.com 8.8.8.8
```

**解决方案:**
- 检查防火墙设置
- 确认网络连接正常
- 验证DNS服务器可达

## ⚙️ 配置示例

### DDNS配置示例
假设主域名为 `example.com`：

```bash
# 需要配置的DNS记录
ip.example.com      A    123.456.789.123  # 公网IP解析
app.example.com     A    123.456.789.123  # Element Web
mas.example.com     A    123.456.789.123  # 认证服务 (MAS)
rtc.example.com     A    123.456.789.123  # RTC服务
matrix.example.com  A    123.456.789.123  # Matrix服务器/Synapse
```

### 路由器端口映射
```bash
# 外部端口 -> 内部端口
8080 -> 服务器IP:30080   # HTTP
8443 -> 服务器IP:30443   # HTTPS
8448 -> 服务器IP:30448   # 联邦
30881 -> 服务器IP:30881  # WebRTC TCP
30882 -> 服务器IP:30882  # WebRTC UDP
```

## 🛡️ 安全考虑

### 防火墙配置
```bash
# 开放必要端口
ufw allow 30080/tcp   # HTTP NodePort
ufw allow 30443/tcp   # HTTPS NodePort
ufw allow 30448/tcp   # 联邦 NodePort
ufw allow 30881/tcp   # WebRTC TCP
ufw allow 30882/udp   # WebRTC UDP
ufw allow 30152:30352/udp  # WebRTC UDP范围
```

### 网络隔离
- 服务部署在内网
- 通过端口映射对外提供服务
- 最小化暴露端口

## 📋 检查清单

部署前请确认：

- [ ] 主域名已注册并可管理DNS
- [ ] DDNS服务已配置并正常运行
- [ ] 所有子域名A记录已创建
- [ ] 路由器端口映射已配置
- [ ] 防火墙规则已设置
- [ ] 网络连通性正常
- [ ] DNS解析正常

## 🆘 故障排除

### 网络检测失败
1. 检查网络连接
2. 验证DNS配置
3. 确认防火墙设置
4. 测试端口连通性

### IP获取失败
1. 检查DDNS配置
2. 验证域名解析
3. 确认A记录配置
4. 测试DNS服务器连通性

---

**更新时间**: 2025-06-13  
**适用版本**: Matrix ESS Community v5.0.0  
**遵循标准**: 需求文档网络配置要求
