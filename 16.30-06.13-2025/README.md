# Matrix ESS Community 自动部署脚本 v5.0.0

## 🎯 重新设计版本

基于所有已知信息重新设计的Matrix ESS Community自动部署脚本，专注于：
- **小白友好**: 简化交互，减少选择
- **逻辑严谨**: 移除无用功能，优化流程  
- **完全动态**: 不依赖硬编码路径、子域名、端口
- **模块化设计**: 分离主脚本和子脚本
- **最小化修改**: 对上游项目保持最小修改
- **官方规范**: 严格遵循ESS官方最新规范25.6.1

## 📁 脚本架构

```
16.30-06.13-2025/
├── setup.sh           # 主脚本 - 配置收集和菜单
├── deploy.sh          # 部署脚本 - 专注核心部署
├── cleanup.sh         # 清理脚本 - 快速清理
└── README.md          # 说明文档
```

## ✨ 主要特性

### 🔧 **完全动态配置**
- ❌ 无硬编码路径、子域名、端口
- ✅ 运行时收集所有配置信息
- ✅ 支持完全自定义的域名和端口
- ✅ 动态生成配置文件

### 📋 **配置文件完整性**
配置文件包含所有必要信息：
- **路径配置**: 脚本目录、安装目录、配置文件路径
- **域名配置**: 服务器域名、所有子域名
- **端口配置**: HTTP、HTTPS、联邦、NodePort、WebRTC端口
- **管理员配置**: 用户名、密码
- **证书配置**: 邮箱、环境设置
- **版本信息**: ESS、K3s、Helm版本
- **网络配置**: 公网IP、UDP范围
- **部署配置**: 命名空间、超时设置

### 🎨 **小白友好设计**
- **简化菜单**: 只有4个主要选项
- **智能默认值**: 提供合理的默认配置
- **自动生成**: 基于主域名自动生成子域名
- **一键部署**: 配置完成后一键部署
- **清晰反馈**: 详细的进度和状态信息

### 📊 **基于官方最新规范**
ESS配置文件严格遵循官方规范：
- **serverName**: Matrix服务器名称
- **ingress**: 全局Ingress配置，支持自定义端口
- **elementWeb**: Element Web客户端配置
- **matrixAuthenticationService**: MAS认证服务
- **matrixRTC**: WebRTC视频会议服务
- **synapse**: Synapse主服务器
- **postgresql**: 内置数据库
- **haproxy**: 负载均衡器
- **wellKnownDelegation**: 联邦发现配置

## 🚀 使用方法

### 快速开始
```bash
# 1. 下载脚本
wget https://github.com/niublab/aiya/raw/main/16.30-06.13-2025/setup.sh
chmod +x setup.sh

# 2. 运行主脚本
sudo ./setup.sh

# 3. 选择"1) 一键部署"
# 4. 按提示输入配置信息
# 5. 确认部署
```

### 配置示例
```
Matrix服务器域名: matrix.example.com
Element Web域名: [默认: element.example.com]
认证服务域名: [默认: auth.example.com]  
RTC服务域名: [默认: rtc.example.com]
Synapse域名: [默认: matrix.example.com]
安装目录: [默认: /opt/matrix]
HTTP端口: [默认: 8080]
HTTPS端口: [默认: 8443]
联邦端口: [默认: 8448]
管理员用户名: [默认: admin]
管理员密码: [输入密码]
证书邮箱: admin@example.com
```

## 📋 菜单选项

### 1️⃣ **一键部署 Matrix ESS**
- 收集配置信息
- 生成ESS配置文件
- 显示配置摘要
- 执行自动部署

### 2️⃣ **管理现有部署**
- 查看当前配置
- 管理服务状态
- 更新配置 (开发中)

### 3️⃣ **完全清理**
- 清理ESS部署
- 清理cert-manager
- 清理K3s集群
- 清理文件和配置

### 4️⃣ **系统信息**
- 脚本版本信息
- ESS版本信息
- 系统资源状态
- 当前配置信息

## 📄 生成的文件

### 配置文件
- **`matrix-config.env`**: 环境配置文件，包含所有自定义配置
- **`ess-values.yaml`**: ESS Helm配置文件，基于官方最新规范

### 部署信息
- **`deployment-summary.txt`**: 部署摘要，包含访问地址和配置信息

## 🔧 技术规范

### 系统要求
- **操作系统**: Debian 11+ / Ubuntu 20.04+
- **内存**: 最少4GB，推荐8GB+
- **存储**: 最少20GB可用空间
- **权限**: root或sudo权限

### 版本信息
- **脚本版本**: 5.0.0
- **ESS版本**: 25.6.1 (官方最新稳定版)
- **K3s版本**: v1.32.5+k3s1
- **Helm版本**: v3.18.2
- **cert-manager版本**: v1.18.0

### 端口配置
- **HTTP**: 8080 (可自定义)
- **HTTPS**: 8443 (可自定义)
- **联邦**: 8448 (可自定义)
- **NodePort HTTP**: 30080
- **NodePort HTTPS**: 30443
- **NodePort 联邦**: 30448
- **WebRTC TCP**: 30881
- **WebRTC UDP**: 30882

## 🎯 设计改进

### 相比之前版本的改进
1. **简化交互**: 从复杂的多级菜单简化为4个主要选项
2. **移除冗余**: 去掉了无用的检测功能和过多的确认步骤
3. **动态配置**: 完全消除硬编码，支持任意自定义
4. **模块化**: 分离主脚本和功能脚本，职责清晰
5. **官方规范**: 严格遵循ESS最新官方规范
6. **逻辑严谨**: 优化部署流程，减少出错可能

### 遵循的原则
- ✅ **基于事实**: 严格基于ESS官方文档
- ✅ **需求文档**: 遵循需求文档要求
- ✅ **小白友好**: 操作简单，提示清晰
- ✅ **最小化修改**: 对上游项目保持最小修改
- ✅ **完全动态**: 无硬编码依赖

## ⚠️ 重要说明

1. **许可证**: 仅限非商业用途 (AGPL-3.0)
2. **官方规范**: 基于ESS Community 25.6.1官方最新规范
3. **测试环境**: 建议先在测试环境验证
4. **DNS配置**: 部署后需要配置域名DNS解析
5. **防火墙**: 确保开放相应端口

---

**版本**: 5.0.0  
**发布日期**: 2025-06-13 16:30  
**基于**: ESS Community 25.6.1 官方规范  
**设计理念**: 小白友好，逻辑严谨，完全动态
