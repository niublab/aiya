# Matrix ESS Community 配置管理说明

## 🔧 配置文件管理

### 配置文件位置
- **文件名**: `matrix-config.env`
- **位置**: 脚本目录下
- **格式**: Shell环境变量格式

### 配置文件内容
配置文件包含完整的部署配置信息：

```bash
# 路径配置
SCRIPT_DIR="/path/to/script"
INSTALL_DIR="/opt/matrix"
CONFIG_FILE="/path/to/matrix-config.env"

# 域名配置
MAIN_DOMAIN="example.com"
SERVER_NAME="matrix.example.com"
WEB_HOST="app.example.com"
AUTH_HOST="mas.example.com"
RTC_HOST="rtc.example.com"
SYNAPSE_HOST="matrix.example.com"

# 端口配置
HTTP_PORT="8080"
HTTPS_PORT="8443"
FEDERATION_PORT="8448"
WEBRTC_TCP_PORT="30881"
WEBRTC_UDP_PORT="30882"

# 管理员配置
ADMIN_USERNAME="admin"
ADMIN_PASSWORD="password"

# 证书配置
CERT_EMAIL="admin@example.com"

# 网络配置
IP_METHOD="ddns"
PUBLIC_IP="$(dig +short ip.example.com @8.8.8.8)"
```

## 🚀 智能配置处理

### 首次部署
当配置文件不存在时：
1. 自动进入配置收集流程
2. 收集所有必要配置信息
3. 生成完整的配置文件
4. 继续部署流程

### 再次部署
当配置文件已存在时：

#### 1. 显示现有配置摘要
```bash
发现现有配置文件: /path/to/matrix-config.env
现有配置摘要:
  主域名: example.com
  Element Web: app.example.com
  认证服务: mas.example.com
  RTC服务: rtc.example.com
  Matrix服务器: matrix.example.com
  安装目录: /opt/matrix
  HTTP端口: 8080
  HTTPS端口: 8443
```

#### 2. 询问是否重新设置
```bash
是否重新设置配置 [y/N]: 
```

- **默认选择 (N)**: 直接使用现有配置，跳过配置收集
- **重新设置 (Y)**: 进入配置收集流程，重新设置所有配置

#### 3. 智能处理逻辑
- **使用现有配置**: 
  - 加载配置文件
  - 跳过配置收集
  - 直接进行网络检测
  - 生成ESS配置
  - 开始部署

- **重新设置配置**:
  - 进入完整配置收集流程
  - 覆盖现有配置文件
  - 继续正常部署流程

## 📋 配置管理功能

### 查看配置详情
在"管理现有部署"菜单中可以查看完整的配置详情：

```bash
当前配置详情
================================

域名配置:
  主域名: example.com
  Matrix服务器: matrix.example.com
  Element Web: app.example.com
  认证服务: mas.example.com
  RTC服务: rtc.example.com
  Synapse: matrix.example.com

路径配置:
  脚本目录: /path/to/script
  安装目录: /opt/matrix
  配置文件: /path/to/matrix-config.env

端口配置:
  HTTP端口: 8080
  HTTPS端口: 8443
  联邦端口: 8448
  WebRTC TCP: 30881
  WebRTC UDP: 30882

网络配置:
  IP获取方式: ddns
  公网IP: 123.456.789.123

管理员配置:
  用户名: admin
  密码: [已设置]

证书配置:
  邮箱: admin@example.com

版本信息:
  ESS版本: 25.6.1
  K3s版本: v1.32.5+k3s1
  Helm版本: v3.18.2
```

### 管理选项
1. **查看部署状态**: 检查K3s和ESS服务状态
2. **重新部署**: 基于现有配置重新部署
3. **更新配置**: 重新进入配置收集流程
4. **返回主菜单**: 返回主菜单

## 🔄 配置更新流程

### 更新单个配置项
可以手动编辑配置文件：
```bash
# 编辑配置文件
nano matrix-config.env

# 修改需要的配置项
HTTP_PORT="8090"
HTTPS_PORT="8453"

# 保存并重新部署
```

### 完全重新配置
通过脚本菜单重新配置：
1. 选择"管理现有部署"
2. 选择"更新配置"
3. 进入完整配置收集流程
4. 重新设置所有配置项

## ⚠️ 注意事项

### 配置文件安全
- 配置文件包含敏感信息（密码等）
- 文件权限设置为600（仅所有者可读写）
- 不要将配置文件提交到版本控制系统

### 配置兼容性
- 修改配置后建议重新部署
- 某些配置修改可能需要重新生成证书
- 域名修改需要更新DNS配置

### 备份建议
- 部署前备份现有配置文件
- 重要配置修改前创建备份
- 定期备份配置文件到安全位置

## 🛠️ 故障排除

### 配置文件损坏
```bash
# 删除损坏的配置文件
rm matrix-config.env

# 重新运行脚本进行配置
./setup.sh
```

### 配置加载失败
```bash
# 检查配置文件语法
bash -n matrix-config.env

# 检查文件权限
ls -la matrix-config.env

# 手动加载测试
source matrix-config.env
echo $SERVER_NAME
```

### 配置不完整
如果配置文件缺少某些变量：
1. 删除不完整的配置文件
2. 重新运行脚本
3. 完整配置所有选项

## 📖 最佳实践

### 1. 配置规划
- 部署前规划好所有域名
- 确定端口分配方案
- 准备好证书邮箱

### 2. 配置管理
- 使用版本控制管理配置模板
- 为不同环境创建不同配置
- 定期检查配置有效性

### 3. 安全考虑
- 定期更改管理员密码
- 保护配置文件访问权限
- 不在日志中记录敏感信息

---

**更新时间**: 2025-06-13  
**适用版本**: Matrix ESS Community v5.0.0  
**配置管理**: 智能化配置处理和管理
