# ESS-Helm外部Nginx反代配置模板
# 复制此文件为 ess-config.env 并根据需要修改配置

# ==================== 基础域名配置 ====================
# 主域名 (必需) - 请修改为您的实际域名
# 示例: DOMAIN="matrix.example.com"
DOMAIN="your-domain.com"

# 子域名配置 (可选，默认基于主域名生成)
WEB_SUBDOMAIN="app"          # Element Web: app.your-domain.com
AUTH_SUBDOMAIN="mas"         # 认证服务: mas.your-domain.com  
RTC_SUBDOMAIN="rtc"          # RTC服务: rtc.your-domain.com
MATRIX_SUBDOMAIN="matrix"    # Matrix服务器: matrix.your-domain.com

# ==================== 端口配置 ====================
# 外部访问端口 (非标准端口)
HTTP_PORT="8080"             # HTTP端口 (替代80)
HTTPS_PORT="8443"            # HTTPS端口 (替代443)
FEDERATION_PORT="8448"       # Matrix联邦端口

# WebRTC端口配置
WEBRTC_TCP_PORT="30881"      # WebRTC TCP端口
WEBRTC_UDP_PORT="30882"      # WebRTC UDP端口
WEBRTC_UDP_RANGE_START="30152"  # WebRTC UDP范围开始
WEBRTC_UDP_RANGE_END="30352"    # WebRTC UDP范围结束

# K3s内部端口 (通常不需要修改)
K3S_HTTP_PORT="8080"         # K3s内部HTTP端口
K3S_HTTPS_PORT="8443"        # K3s内部HTTPS端口

# ==================== 部署路径配置 ====================
# 安装目录
INSTALL_DIR="/opt/matrix-ess"

# Kubernetes命名空间
NAMESPACE="ess"

# 数据存储路径
DATA_DIR="/var/lib/matrix-ess"

# 日志路径
LOG_DIR="/var/log/matrix-ess"

# ==================== SSL证书配置 ====================
# 证书邮箱 (用于Let's Encrypt)
CERT_EMAIL="admin@your-domain.com"

# 证书类型 (letsencrypt|letsencrypt-staging|custom|self-signed)
# letsencrypt: 生产环境证书 (有速率限制)
# letsencrypt-staging: 测试环境证书 (无速率限制，但浏览器会显示不安全)
# custom: 使用自定义证书文件
# self-signed: 生成自签名证书 (仅用于测试)
CERT_TYPE="letsencrypt"

# 证书验证方式 (http|dns)
# http: HTTP验证 (需要80端口可访问)
# dns: DNS验证 (推荐，无需开放80端口)
CERT_CHALLENGE="dns"

# 测试模式 (true|false) - 启用时自动使用staging证书
TEST_MODE="false"

# DNS验证配置 (当CERT_CHALLENGE=dns时使用)
# 支持的DNS提供商: cloudflare, route53, digitalocean, etc.
DNS_PROVIDER="cloudflare"

# Cloudflare配置 (推荐)
# 获取API Token: https://dash.cloudflare.com/profile/api-tokens
# 权限: Zone:Zone:Read, Zone:DNS:Edit (所有区域或特定区域)
CLOUDFLARE_API_TOKEN=""          # Cloudflare API Token (必需)
# 注意: 使用API Token时不需要Zone ID，certbot会自动检测

# 其他DNS提供商配置示例 (根据需要启用)
# Route53 (AWS)
# AWS_ACCESS_KEY_ID=""
# AWS_SECRET_ACCESS_KEY=""
# AWS_DEFAULT_REGION="us-east-1"

# DigitalOcean
# DO_API_TOKEN=""

# 自定义证书路径 (当CERT_TYPE=custom时使用)
CUSTOM_CERT_PATH="/etc/ssl/certs/your-domain.crt"
CUSTOM_KEY_PATH="/etc/ssl/private/your-domain.key"

# 自签名证书配置 (当CERT_TYPE=self-signed时使用)
SELF_SIGNED_DAYS="365"           # 证书有效期 (天)
SELF_SIGNED_COUNTRY="CN"         # 国家代码
SELF_SIGNED_STATE="Beijing"      # 省份
SELF_SIGNED_CITY="Beijing"       # 城市
SELF_SIGNED_ORG="Matrix Server"  # 组织名称

# ==================== 数据库配置 ====================
# 数据库类型 (internal|external)
DB_TYPE="internal"

# 外部PostgreSQL配置 (当DB_TYPE=external时使用)
POSTGRES_HOST="localhost"
POSTGRES_PORT="5432"
POSTGRES_DB_SYNAPSE="synapse"
POSTGRES_DB_MAS="mas"
POSTGRES_USER_SYNAPSE="synapse_user"
POSTGRES_USER_MAS="mas_user"
POSTGRES_PASSWORD_SYNAPSE="your_synapse_password"
POSTGRES_PASSWORD_MAS="your_mas_password"

# ==================== 管理员配置 ====================
# 初始管理员用户
ADMIN_USERNAME="admin"
ADMIN_EMAIL="admin@your-domain.com"

# 管理员密码 (留空自动生成)
ADMIN_PASSWORD=""

# ==================== 网络配置 ====================
# 服务器内网IP (自动检测，通常不需要修改)
SERVER_IP=""

# 公网IP获取方式 (auto|manual|ddns)
PUBLIC_IP_METHOD="auto"

# 手动指定公网IP (当PUBLIC_IP_METHOD=manual时使用)
PUBLIC_IP=""

# DDNS域名 (当PUBLIC_IP_METHOD=ddns时使用)
DDNS_DOMAIN="ip.your-domain.com"

# ==================== 高级配置 ====================
# 启用功能开关
ENABLE_FEDERATION="true"     # 启用Matrix联邦
ENABLE_REGISTRATION="false"  # 启用用户注册
ENABLE_GUEST_ACCESS="false"  # 启用访客访问
ENABLE_METRICS="true"        # 启用监控指标

# 性能配置
MAX_UPLOAD_SIZE="50M"        # 最大文件上传大小
WORKER_CONNECTIONS="1024"    # Nginx工作连接数
KEEPALIVE_TIMEOUT="65"       # 连接保持时间

# 安全配置
ENABLE_RATE_LIMITING="true"  # 启用请求频率限制
ENABLE_FAIL2BAN="false"      # 启用Fail2Ban
ENABLE_FIREWALL="true"       # 启用UFW防火墙

# ==================== 备份配置 ====================
# 备份目录
BACKUP_DIR="/var/backups/matrix-ess"

# 备份保留天数
BACKUP_RETENTION_DAYS="30"

# 自动备份 (true|false)
AUTO_BACKUP="true"

# 备份时间 (cron格式)
BACKUP_SCHEDULE="0 2 * * *"  # 每天凌晨2点

# ==================== 监控配置 ====================
# 启用监控
ENABLE_MONITORING="true"

# 监控端口
METRICS_PORT="9090"

# 告警邮箱
ALERT_EMAIL="alerts@your-domain.com"

# ==================== 日志配置 ====================
# 日志级别 (DEBUG|INFO|WARNING|ERROR)
LOG_LEVEL="INFO"

# 日志轮转
LOG_ROTATION="true"
LOG_MAX_SIZE="100M"
LOG_MAX_FILES="10"

# ==================== 开发/测试配置 ====================
# 开发模式 (true|false)
DEV_MODE="false"

# 测试域名 (开发模式使用)
TEST_DOMAIN="test.your-domain.com"

# 跳过SSL验证 (仅开发模式)
SKIP_SSL_VERIFY="false"

# ==================== 自定义配置 ====================
# 自定义Nginx配置文件路径
CUSTOM_NGINX_CONFIG=""

# 自定义ESS values文件路径
CUSTOM_ESS_VALUES=""

# 额外的Helm参数
EXTRA_HELM_ARGS=""

# ==================== 环境变量 ====================
# 设置时区
TZ="Asia/Shanghai"

# 设置语言
LANG="en_US.UTF-8"

# ==================== 注释说明 ====================
# 1. 所有以 # 开头的行都是注释
# 2. 配置值不要包含空格，除非用引号包围
# 3. 布尔值使用 true/false
# 4. 端口号必须是数字
# 5. 域名不要包含协议前缀 (http://或https://)
# 6. 路径必须是绝对路径
# 7. 邮箱地址必须是有效格式

# ==================== 快速配置示例 ====================
# 最小化配置 - 只需修改以下几项即可开始部署:
#
# DOMAIN="matrix.example.com"                    # 改为您的域名
# CERT_EMAIL="admin@matrix.example.com"          # 改为您的邮箱
# ADMIN_EMAIL="admin@matrix.example.com"         # 改为管理员邮箱
# DDNS_DOMAIN="ip.matrix.example.com"            # 改为IP获取域名
# ALERT_EMAIL="alerts@matrix.example.com"        # 改为告警邮箱
#
# 其他配置可以保持默认值

# ==================== 使用说明 ====================
# 方法1: 环境变量方式
#   export DOMAIN="matrix.example.com"
#   ./deploy-ess-nginx-proxy.sh
#
# 方法2: 配置文件方式
#   1. 复制此文件: cp ess-config-template.env ess-config.env
#   2. 编辑配置: nano ess-config.env
#   3. 运行部署: ./deploy-ess-nginx-proxy.sh
#   4. 或者导入配置: source ess-config.env && ./deploy-ess-nginx-proxy.sh
#
# 方法3: curl一键部署
#   DOMAIN="matrix.example.com" AUTO_DEPLOY=3 bash <(curl -fsSL ...)

# ==================== 常见配置示例 ====================
# 
# 示例1: 家庭网络部署
# DOMAIN="home.example.com"
# HTTP_PORT="8080"
# HTTPS_PORT="8443"
# DB_TYPE="internal"
# ENABLE_FEDERATION="false"
#
# 示例2: 企业网络部署  
# DOMAIN="matrix.company.com"
# HTTP_PORT="80"
# HTTPS_PORT="443"
# DB_TYPE="external"
# POSTGRES_HOST="db.company.com"
# ENABLE_FEDERATION="true"
#
# 示例3: 云服务器部署
# DOMAIN="chat.mydomain.com"
# HTTP_PORT="8080"
# HTTPS_PORT="8443"
# DB_TYPE="external"
# ENABLE_MONITORING="true"
# AUTO_BACKUP="true"
