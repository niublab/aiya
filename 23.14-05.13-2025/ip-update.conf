# IP自动更新系统配置文件
# 配置文件版本: 1.0.0

# ==================== 基础配置 ====================

# DDNS域名 - 用于获取公网IP地址
# 必须严格使用 dig +short 域名 @DNS服务器 的方式获取
DDNS_DOMAIN="ip.your-domain.com"

# 更新检查间隔 (秒)
# 建议值: 300 (5分钟), 600 (10分钟), 1800 (30分钟)
UPDATE_INTERVAL="300"

# 日志级别 (DEBUG|INFO|WARN|ERROR)
LOG_LEVEL="INFO"

# ==================== DNS配置 ====================

# DNS服务器列表 - 严格按照要求使用8.8.8.8和1.1.1.1
# 脚本会依次尝试这些DNS服务器
DNS_SERVERS=("8.8.8.8" "1.1.1.1")

# DNS查询超时时间 (秒)
DNS_TIMEOUT="5"

# DNS重试次数
DNS_RETRY_COUNT="3"

# ==================== 服务配置 ====================

# 需要重载的服务列表
# 支持的服务类型:
# - nginx: Nginx Web服务器
# - matrix-ess/ess: Matrix ESS服务
# - docker-容器名: Docker容器
# - 其他systemd服务名
SERVICES_TO_RELOAD=("nginx" "matrix-ess")

# 服务重载超时时间 (秒)
SERVICE_RELOAD_TIMEOUT="30"

# 服务重载失败时是否继续 (true|false)
CONTINUE_ON_SERVICE_FAILURE="true"

# ==================== 备份配置 ====================

# 是否启用配置备份 (true|false)
BACKUP_ENABLED="true"

# 备份保留数量
BACKUP_RETENTION_COUNT="10"

# 备份压缩 (true|false)
BACKUP_COMPRESS="false"

# ==================== 文件路径配置 ====================

# Nginx配置文件路径
NGINX_CONFIG_PATH="/etc/nginx/sites-available/matrix-ess"

# ESS配置文件路径
ESS_CONFIG_PATH="/opt/matrix-ess/ess-values.yaml"

# 自定义配置文件路径 (可选)
CUSTOM_CONFIG_PATHS=(
    "/etc/docker/compose.yml"
    "/opt/custom-service/config.yaml"
)

# ==================== 模板配置 ====================

# 是否使用配置模板 (true|false)
USE_TEMPLATES="true"

# Nginx配置模板路径
NGINX_TEMPLATE_PATH="/opt/ip-updater/templates/nginx.conf.template"

# ESS配置模板路径
ESS_TEMPLATE_PATH="/opt/ip-updater/templates/ess-values.template"

# ==================== 通知配置 ====================

# 是否启用通知 (true|false)
NOTIFICATION_ENABLED="true"

# 通知方式 (syslog|email|webhook|telegram)
NOTIFICATION_METHODS=("syslog")

# 邮件通知配置 (当启用email通知时)
EMAIL_TO="admin@your-domain.com"
EMAIL_FROM="ip-updater@your-domain.com"
EMAIL_SMTP_SERVER="smtp.your-domain.com"
EMAIL_SMTP_PORT="587"
EMAIL_SMTP_USER="ip-updater@your-domain.com"
EMAIL_SMTP_PASSWORD=""

# Webhook通知配置 (当启用webhook通知时)
WEBHOOK_URL="https://your-webhook-url.com/notify"
WEBHOOK_SECRET=""

# Telegram通知配置 (当启用telegram通知时)
TELEGRAM_BOT_TOKEN=""
TELEGRAM_CHAT_ID=""

# ==================== 安全配置 ====================

# 是否验证IP地址格式 (true|false)
VALIDATE_IP_FORMAT="true"

# 是否验证IP地址范围 (true|false)
# 排除私有IP地址范围
VALIDATE_IP_RANGE="true"

# 允许的IP地址范围 (CIDR格式)
ALLOWED_IP_RANGES=(
    "0.0.0.0/0"  # 允许所有公网IP
)

# 禁止的IP地址范围 (CIDR格式)
BLOCKED_IP_RANGES=(
    "10.0.0.0/8"      # 私有网络
    "172.16.0.0/12"   # 私有网络
    "192.168.0.0/16"  # 私有网络
    "127.0.0.0/8"     # 本地回环
    "169.254.0.0/16"  # 链路本地
)

# ==================== 性能配置 ====================

# 并发更新配置文件 (true|false)
PARALLEL_UPDATE="false"

# 最大并发数
MAX_PARALLEL_JOBS="3"

# 配置文件更新超时 (秒)
CONFIG_UPDATE_TIMEOUT="60"

# ==================== 调试配置 ====================

# 是否启用调试模式 (true|false)
DEBUG_MODE="false"

# 调试日志文件
DEBUG_LOG_FILE="/opt/ip-updater/logs/debug.log"

# 是否保留临时文件 (true|false)
KEEP_TEMP_FILES="false"

# ==================== 高级配置 ====================

# 自定义更新脚本路径 (可选)
CUSTOM_UPDATE_SCRIPTS=(
    "/opt/ip-updater/scripts/custom-update-1.sh"
    "/opt/ip-updater/scripts/custom-update-2.sh"
)

# 更新前执行的脚本 (可选)
PRE_UPDATE_SCRIPT="/opt/ip-updater/scripts/pre-update.sh"

# 更新后执行的脚本 (可选)
POST_UPDATE_SCRIPT="/opt/ip-updater/scripts/post-update.sh"

# 是否在更新失败时回滚 (true|false)
ENABLE_ROLLBACK="true"

# 回滚超时时间 (秒)
ROLLBACK_TIMEOUT="120"

# ==================== 监控配置 ====================

# 是否启用监控 (true|false)
MONITORING_ENABLED="true"

# 监控指标文件路径
METRICS_FILE="/opt/ip-updater/metrics/ip-update.metrics"

# 是否记录性能指标 (true|false)
RECORD_PERFORMANCE="true"

# 健康检查URL (可选)
HEALTH_CHECK_URL="https://your-domain.com/health"

# ==================== 环境变量 ====================

# 设置环境变量
export PATH="/usr/local/bin:/usr/bin:/bin"
export LANG="en_US.UTF-8"
export TZ="Asia/Shanghai"

# ==================== 兼容性配置 ====================

# 兼容旧版本配置 (true|false)
LEGACY_COMPATIBILITY="false"

# 配置文件格式版本
CONFIG_VERSION="1.0.0"

# ==================== 示例配置 ====================

# 以下是一些常见场景的配置示例:

# 示例1: 家庭网络配置
# DDNS_DOMAIN="home.example.com"
# UPDATE_INTERVAL="600"
# SERVICES_TO_RELOAD=("nginx")
# NOTIFICATION_METHODS=("syslog")

# 示例2: 企业网络配置
# DDNS_DOMAIN="office.company.com"
# UPDATE_INTERVAL="300"
# SERVICES_TO_RELOAD=("nginx" "matrix-ess" "docker-app")
# NOTIFICATION_METHODS=("email" "webhook")
# EMAIL_TO="admin@company.com"

# 示例3: 云服务器配置
# DDNS_DOMAIN="server.mydomain.com"
# UPDATE_INTERVAL="180"
# SERVICES_TO_RELOAD=("nginx" "matrix-ess")
# NOTIFICATION_METHODS=("telegram" "webhook")
# MONITORING_ENABLED="true"

# ==================== 注意事项 ====================

# 1. DDNS_DOMAIN 必须是一个有效的域名，且配置了A记录指向当前公网IP
# 2. DNS_SERVERS 严格使用 8.8.8.8 和 1.1.1.1，不可修改
# 3. 所有路径必须是绝对路径
# 4. 布尔值使用 true/false，不要使用 yes/no 或 1/0
# 5. 数组配置使用括号，元素用空格分隔
# 6. 密码等敏感信息建议使用环境变量或单独的密钥文件
# 7. 修改配置后需要重启 ip-update.service 服务

# ==================== 配置验证 ====================

# 配置文件语法检查命令:
# bash -n /opt/ip-updater/config/ip-update.conf

# 配置有效性检查命令:
# /opt/ip-updater/bin/ip-update.sh --check-config

# ==================== 更新说明 ====================

# 配置文件更新时间: 2025-01-XX
# 最后修改者: IP更新系统
# 变更说明: 初始配置文件
