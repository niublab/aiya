# Matrix ESS Community è‡ªåŠ¨éƒ¨ç½²è„šæœ¬

ä¸€é”®éƒ¨ç½² Matrix Element Server Suite (ESS) Community ç‰ˆæœ¬çš„è‡ªåŠ¨åŒ–è„šæœ¬ï¼Œæ”¯æŒå†…ç½‘å’Œå…¬ç½‘éƒ¨ç½²ã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ä¸€é”®å®‰è£…

```bash
bash <(curl -fsSL https://raw.githubusercontent.com/niublab/aiya/main/setup.sh)
```

### è‡ªå®šä¹‰ä»“åº“å®‰è£…

å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯ fork æˆ–å…¶ä»–ä»“åº“ï¼Œåªéœ€ä¿®æ”¹ä»“åº“è·¯å¾„ï¼š

```bash
# æ›¿æ¢ YOUR_USERNAME/YOUR_REPO ä¸ºæ‚¨çš„ä»“åº“è·¯å¾„
bash <(curl -fsSL https://raw.githubusercontent.com/YOUR_USERNAME/YOUR_REPO/main/setup.sh)
```

è„šæœ¬ä¼šè‡ªåŠ¨æ£€æµ‹æºä»“åº“ï¼Œæ— éœ€ä¿®æ”¹è„šæœ¬å†…å®¹ã€‚

## ğŸ“‹ ç³»ç»Ÿè¦æ±‚

- **æ“ä½œç³»ç»Ÿ**: Debian 11+ æˆ– Ubuntu 20.04+
- **å†…å­˜**: æœ€ä½ 2GBï¼Œæ¨è 4GB+
- **CPU**: æœ€ä½ 2 æ ¸ï¼Œæ¨è 4 æ ¸+
- **å­˜å‚¨**: æœ€ä½ 20GB å¯ç”¨ç©ºé—´
- **ç½‘ç»œ**: ç¨³å®šçš„äº’è”ç½‘è¿æ¥
- **æƒé™**: root æƒé™

## ğŸŒ ç½‘ç»œé…ç½®

### æ ‡å‡†ç«¯å£éƒ¨ç½² (æ¨è)

å¦‚æœæ‚¨çš„ ISP æ”¯æŒæ ‡å‡†ç«¯å£ï¼š

**è·¯ç”±å™¨ç«¯å£è½¬å‘é…ç½®ï¼š**
- `80 â†’ 30080` (HTTP)
- `443 â†’ 30443` (HTTPS)
- `8448 â†’ 30448` (Matrix è”é‚¦)

### éæ ‡å‡†ç«¯å£éƒ¨ç½²

å¦‚æœæ‚¨çš„ ISP å°é”äº† 80/443 ç«¯å£ï¼Œéœ€è¦é¢å¤–é…ç½® DNS SRV è®°å½•ã€‚

#### DNS SRV è®°å½•é…ç½®

åœ¨æ‚¨çš„ DNS æä¾›å•†ï¼ˆå¦‚ Cloudflareï¼‰ä¸­æ·»åŠ ä»¥ä¸‹ SRV è®°å½•ï¼š

**1. Matrix å®¢æˆ·ç«¯å‘ç°è®°å½•ï¼š**
- **ç±»å‹**: `SRV`
- **åç§°**: `_matrix._tcp`
- **ç›®æ ‡**: `matrix.${SERVER_NAME}` (ä¾‹å¦‚: `matrix.example.com`)
- **ç«¯å£**: `${HTTPS_PORT}` (ä¾‹å¦‚: `8443`)
- **ä¼˜å…ˆçº§**: `10`
- **æƒé‡**: `5`

**2. Matrix è”é‚¦å‘ç°è®°å½•ï¼š**
- **ç±»å‹**: `SRV`
- **åç§°**: `_matrix._tcp`
- **ç›®æ ‡**: `matrix.${SERVER_NAME}` (ä¾‹å¦‚: `matrix.example.com`)
- **ç«¯å£**: `${FEDERATION_PORT}` (ä¾‹å¦‚: `8448`)
- **ä¼˜å…ˆçº§**: `10`
- **æƒé‡**: `5`

#### Cloudflare é…ç½®ç¤ºä¾‹

å‡è®¾æ‚¨çš„åŸŸåæ˜¯ `example.com`ï¼ŒHTTPS ç«¯å£æ˜¯ `8443`ï¼Œè”é‚¦ç«¯å£æ˜¯ `8448`ï¼š

```
ç±»å‹: SRV
åç§°: _matrix._tcp
ç›®æ ‡: matrix.example.com
ç«¯å£: 8443
ä¼˜å…ˆçº§: 10
æƒé‡: 5

ç±»å‹: SRV  
åç§°: _matrix._tcp
ç›®æ ‡: matrix.example.com
ç«¯å£: 8448
ä¼˜å…ˆçº§: 10
æƒé‡: 5
```

**æ³¨æ„**: ä¸¤æ¡è®°å½•çš„åç§°ç›¸åŒï¼Œä½†ç«¯å£ä¸åŒã€‚ä¸€ä¸ªç”¨äºå®¢æˆ·ç«¯è¿æ¥ï¼Œä¸€ä¸ªç”¨äºæœåŠ¡å™¨è”é‚¦ã€‚

### è·¯ç”±å™¨ç«¯å£è½¬å‘

æ— è®ºä½¿ç”¨å“ªç§ç«¯å£é…ç½®ï¼Œéƒ½éœ€è¦åœ¨è·¯ç”±å™¨ä¸­è®¾ç½®ç«¯å£è½¬å‘ï¼š

```
å¤–éƒ¨ç«¯å£ â†’ å†…éƒ¨ç«¯å£ (NodePort)
${HTTP_PORT} â†’ 30080
${HTTPS_PORT} â†’ 30443  
${FEDERATION_PORT} â†’ 30448
```

## ğŸ”§ åŠŸèƒ½ç‰¹æ€§

- âœ… **ä¸€é”®éƒ¨ç½²**: å…¨è‡ªåŠ¨å®‰è£…å’Œé…ç½®
- âœ… **K3s é›†ç¾¤**: è½»é‡çº§ Kubernetes ç¯å¢ƒ
- âœ… **SSL è¯ä¹¦**: è‡ªåŠ¨ç”³è¯· Let's Encrypt è¯ä¹¦
- âœ… **DNS éªŒè¯**: æ”¯æŒ Cloudflare DNS éªŒè¯
- âœ… **å¤šç«¯å£æ”¯æŒ**: æ”¯æŒæ ‡å‡†å’Œéæ ‡å‡†ç«¯å£
- âœ… **é…ç½®ä¿®å¤**: è‡ªåŠ¨ä¿®å¤å¸¸è§é…ç½®é—®é¢˜
- âœ… **ç”¨æˆ·ç®¡ç†**: è‡ªåŠ¨åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·
- âœ… **å¥åº·æ£€æŸ¥**: å…¨é¢çš„æœåŠ¡çŠ¶æ€æ£€æŸ¥
- âœ… **æ›´æ–°ç®¡ç†**: æ”¯æŒè„šæœ¬å’ŒæœåŠ¡æ›´æ–°
- âœ… **å¤‡ä»½æ¢å¤**: æ•°æ®å¤‡ä»½å’Œæ¢å¤åŠŸèƒ½

## ğŸ“¦ åŒ…å«ç»„ä»¶

- **Matrix Synapse**: Matrix åè®®æœåŠ¡å™¨
- **Element Web**: Web å®¢æˆ·ç«¯ç•Œé¢
- **Matrix Authentication Service (MAS)**: è®¤è¯æœåŠ¡
- **Matrix RTC**: å®æ—¶é€šä¿¡æœåŠ¡
- **PostgreSQL**: æ•°æ®åº“
- **HAProxy**: è´Ÿè½½å‡è¡¡å™¨
- **cert-manager**: è¯ä¹¦ç®¡ç†
- **Traefik**: å…¥å£æ§åˆ¶å™¨

## ğŸ¯ éƒ¨ç½²æµç¨‹

1. **ç¯å¢ƒæ£€æŸ¥**: éªŒè¯ç³»ç»Ÿè¦æ±‚å’Œç½‘ç»œè¿æ¥
2. **ä¾èµ–å®‰è£…**: å®‰è£…å¿…è¦çš„ç³»ç»Ÿè½¯ä»¶åŒ…
3. **é…ç½®æ”¶é›†**: äº¤äº’å¼æ”¶é›†éƒ¨ç½²é…ç½®
4. **K3s å®‰è£…**: éƒ¨ç½²è½»é‡çº§ Kubernetes
5. **Helm å®‰è£…**: å®‰è£…åŒ…ç®¡ç†å™¨
6. **cert-manager**: é…ç½®è¯ä¹¦ç®¡ç†
7. **ESS éƒ¨ç½²**: éƒ¨ç½² Matrix æœåŠ¡å¥—ä»¶
8. **é…ç½®ä¿®å¤**: è‡ªåŠ¨ä¿®å¤ç«¯å£å’Œè·¯ç”±é…ç½®
9. **ç”¨æˆ·åˆ›å»º**: åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·
10. **å¥åº·æ£€æŸ¥**: éªŒè¯æ‰€æœ‰æœåŠ¡çŠ¶æ€

## ğŸ” å®‰å…¨é…ç½®

### SSL è¯ä¹¦

è„šæœ¬æ”¯æŒä¸¤ç§è¯ä¹¦ç¯å¢ƒï¼š

- **ç”Ÿäº§ç¯å¢ƒ** (æ¨è): Let's Encrypt æ­£å¼è¯ä¹¦ï¼Œè¢«æ‰€æœ‰æµè§ˆå™¨ä¿¡ä»»
- **æµ‹è¯•ç¯å¢ƒ**: Let's Encrypt æµ‹è¯•è¯ä¹¦ï¼Œä»…ç”¨äºæµ‹è¯•

### Cloudflare API Token

éœ€è¦å…·æœ‰ä»¥ä¸‹æƒé™çš„ Cloudflare API Tokenï¼š

- **Zone:Zone:Read**
- **Zone:DNS:Edit**

åˆ›å»ºæ­¥éª¤ï¼š
1. ç™»å½• Cloudflare Dashboard
2. è¿›å…¥ "My Profile" â†’ "API Tokens"
3. ç‚¹å‡» "Create Token"
4. é€‰æ‹© "Custom token"
5. è®¾ç½®æƒé™å’Œèµ„æºèŒƒå›´

## ğŸ“± å®¢æˆ·ç«¯è¿æ¥

### æ¨èå®¢æˆ·ç«¯

- **Element Desktop**: å®˜æ–¹æ¡Œé¢å®¢æˆ·ç«¯
- **Element Mobile**: iOS/Android ç§»åŠ¨å®¢æˆ·ç«¯
- **FluffyChat**: ç¬¬ä¸‰æ–¹ç§»åŠ¨å®¢æˆ·ç«¯
- **Nheko**: ç¬¬ä¸‰æ–¹æ¡Œé¢å®¢æˆ·ç«¯

### è¿æ¥é…ç½®

**æœåŠ¡å™¨åœ°å€**: `${SERVER_NAME}` (ä¾‹å¦‚: `example.com`)

å¤§å¤šæ•°å®¢æˆ·ç«¯ä¼šè‡ªåŠ¨é€šè¿‡ well-known å‘ç°æˆ– SRV è®°å½•æ‰¾åˆ°æ­£ç¡®çš„æœåŠ¡å™¨é…ç½®ã€‚

### æ‰‹åŠ¨é…ç½®

å¦‚æœè‡ªåŠ¨å‘ç°å¤±è´¥ï¼Œå¯ä»¥æ‰‹åŠ¨é…ç½®ï¼š

- **Homeserver URL**: `https://matrix.${SERVER_NAME}:${HTTPS_PORT}`
- **Identity Server**: ç•™ç©ºæˆ–ä½¿ç”¨é»˜è®¤

## ğŸ› ï¸ ç®¡ç†å‘½ä»¤

éƒ¨ç½²å®Œæˆåï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç®¡ç†æœåŠ¡ï¼š

```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
manage status

# é‡å¯æœåŠ¡
manage restart

# æŸ¥çœ‹æ—¥å¿—
manage logs

# å¤‡ä»½æ•°æ®
manage backup

# æ›´æ–°æœåŠ¡
manage update
```

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **è¯ä¹¦ç”³è¯·å¤±è´¥**
   - æ£€æŸ¥ DNS è®°å½•æ˜¯å¦æ­£ç¡®
   - éªŒè¯ Cloudflare API Token æƒé™
   - ç¡®è®¤åŸŸåè§£æåˆ°æ­£ç¡®çš„ IP

2. **å®¢æˆ·ç«¯è¿æ¥å¤±è´¥**
   - æ£€æŸ¥ SRV è®°å½•é…ç½®
   - éªŒè¯ç«¯å£è½¬å‘è®¾ç½®
   - ç¡®è®¤é˜²ç«å¢™è§„åˆ™

3. **æœåŠ¡å¯åŠ¨å¤±è´¥**
   - æ£€æŸ¥ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ
   - æŸ¥çœ‹ Kubernetes äº‹ä»¶æ—¥å¿—
   - éªŒè¯é…ç½®æ–‡ä»¶è¯­æ³•

### æ—¥å¿—æŸ¥çœ‹

```bash
# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡çŠ¶æ€
kubectl get pods -n ess

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡æ—¥å¿—
kubectl logs -n ess deployment/ess-synapse-main

# æŸ¥çœ‹ç³»ç»Ÿäº‹ä»¶
kubectl get events -n ess --sort-by='.lastTimestamp'
```

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ AGPL-3.0 è®¸å¯è¯ï¼Œä»…é™éå•†ä¸šç”¨é€”ã€‚

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Request æ¥æ”¹è¿›è¿™ä¸ªé¡¹ç›®ã€‚

## ğŸ“ æ”¯æŒ

å¦‚æœæ‚¨é‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š

1. æŸ¥çœ‹æœ¬æ–‡æ¡£çš„æ•…éšœæ’é™¤éƒ¨åˆ†
2. åœ¨ GitHub ä¸Šæäº¤ Issue
3. æä¾›è¯¦ç»†çš„é”™è¯¯æ—¥å¿—å’Œç³»ç»Ÿä¿¡æ¯

---

**æ³¨æ„**: æœ¬è„šæœ¬ä¼šè‡ªåŠ¨æ£€æµ‹æºä»“åº“ï¼Œæ”¯æŒ fork å’Œè‡ªå®šä¹‰ä»“åº“éƒ¨ç½²ã€‚åªéœ€ä¿®æ”¹ä¸‹è½½ URL ä¸­çš„ä»“åº“è·¯å¾„å³å¯ã€‚
